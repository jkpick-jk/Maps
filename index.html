<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Multi User Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
  body { margin: 0; }
  #map { height: 100vh; width: 100%; }

  #locateBtn, #resetBtn {
    position: absolute;
    left: 15px;
    z-index: 1000;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
  }

  #locateBtn { top: 15px; background: white; border: 1px solid #ccc; }
  #resetBtn { top: 60px; background: #ff4d4d; color: white; border: none; }
  #status {
    position: absolute;
    top: 110px;
    left: 15px;
    z-index: 1000;
    background: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 14px;
  }
</style>
</head>

<body>

<button id="locateBtn">Find Me</button>
<button id="resetBtn">Reset Server</button>
<div id="status"></div>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ===== FIREBASE CONFIG =====
var firebaseConfig = {
  apiKey: "AIzaSyCjgp9FkDk7DzaMMEjHVMb3KdByEY3ehIs",
  authDomain: "multimaps-f44a4.firebaseapp.com",
  databaseURL: "https://multimaps-f44a4-default-rtdb.firebaseio.com/",
  projectId: "multimaps-f44a4",
  storageBucket: "multimaps-f44a4.appspot.com",
  messagingSenderId: "784214151922",
  appId: "1:784214151922:web:59de8fdaaaa7a059f9f66b"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.database();

// ===== MAP SETUP =====
var map = L.map('map').setView([14.5995, 120.9842], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

var statusDiv = document.getElementById("status");

// ===== USER SETUP =====
var userId = db.ref("users").push().key;
var myRef = db.ref("users/" + userId);
myRef.onDisconnect().remove(); // remove user on disconnect

var myMarker = null;
var friendsMarkers = {};
var watching = false;

// ===== HELPER: update my lastActive every 5s =====
function heartbeat(lat, lng){
  if(!myRef) return;
  myRef.set({ lat: lat, lng: lng, lastActive: Date.now() });
}

// ===== FIND ME BUTTON =====
document.getElementById("locateBtn").addEventListener("click", function(){

  if(watching) return;
  watching = true;

  if(!navigator.geolocation){ alert("Geolocation not supported"); return; }

  statusDiv.innerText = "Getting location...";

  navigator.geolocation.watchPosition(function(position){
    var lat = position.coords.latitude;
    var lng = position.coords.longitude;

    if(!myMarker){
      myMarker = L.circleMarker([lat, lng], { radius: 8, color:"#fff", fillColor:"#4285F4", fillOpacity:1 })
                   .addTo(map).bindPopup("You");
    } else {
      myMarker.setLatLng([lat, lng]);
    }

    map.setView([lat, lng], 16);

    heartbeat(lat, lng);

  }, function(error){
    statusDiv.innerText = "GPS Error: " + error.message;
  }, { enableHighAccuracy:true, maximumAge:0 });

  // Send heartbeat every 5 seconds in case watchPosition skips
  setInterval(function(){
    if(myMarker){
      var latlng = myMarker.getLatLng();
      heartbeat(latlng.lat, latlng.lng);
    }
  }, 5000);
});

// ===== RESET SERVER BUTTON =====
document.getElementById("resetBtn").addEventListener("click", function(){
  if(confirm("Clear ALL users from server?")){
    db.ref("users").remove();
  }
});

// ===== REALTIME LISTENER =====
db.ref("users").on("value", function(snapshot){
  var users = snapshot.val() || {};
  var now = Date.now();
  var TIMEOUT = 60000; // 60s grace for disappearing

  // update friends
  for(var id in users){
    var user = users[id];

    // remove ghosts immediately if timeout
    if(now - user.lastActive > TIMEOUT){
      db.ref("users/"+id).remove();
      continue;
    }

    if(id === userId) continue;

    if(!friendsMarkers[id]){
      friendsMarkers[id] = L.circleMarker([user.lat, user.lng], { radius:8, color:"#fff", fillColor:"#000", fillOpacity:1 })
                             .addTo(map).bindPopup("Friend");
    } else {
      friendsMarkers[id].setLatLng([user.lat, user.lng]);
    }
  }

  // remove markers of deleted users
  for(var id in friendsMarkers){
    if(!users[id]){
      map.removeLayer(friendsMarkers[id]);
      delete friendsMarkers[id];
    }
  }

});
</script>

</body>
</html>
