<script>
const firebaseConfig = {
  apiKey: "AIzaSyCjgp9FkDk7DzaMMEjHVMb3KdByEY3ehIs",
  authDomain: "multimaps-f44a4.firebaseapp.com",
  databaseURL: "https://multimaps-f44a4-default-rtdb.firebaseio.com/",
  projectId: "multimaps-f44a4",
  storageBucket: "multimaps-f44a4.firebasestorage.app",
  messagingSenderId: "784214151922",
  appId: "1:784214151922:web:59de8fdaaaa7a059f9f66b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const map = L.map('map').setView([14.5995, 120.9842], 15);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

const statusDiv = document.getElementById("status");

// ===== RESET BUTTON =====
const resetBtn = document.createElement("button");
resetBtn.innerText = "Reset Server";
resetBtn.style.position = "absolute";
resetBtn.style.top = "110px";
resetBtn.style.left = "15px";
resetBtn.style.zIndex = "1000";
resetBtn.style.padding = "8px 12px";
resetBtn.style.background = "#ff4d4d";
resetBtn.style.color = "white";
resetBtn.style.border = "none";
resetBtn.style.borderRadius = "6px";
resetBtn.style.cursor = "pointer";
document.body.appendChild(resetBtn);

resetBtn.addEventListener("click", () => {
  if (confirm("Clear ALL users from server?")) {
    db.ref("users").remove();
  }
});

// ===== USER SETUP =====
const userId = db.ref("users").push().key;
const myRef = db.ref("users/" + userId);
myRef.onDisconnect().remove();

let myMarker = null;
const friendsMarkers = {};
let watching = false;

document.getElementById("locateBtn").addEventListener("click", () => {

  if (watching) return;
  watching = true;

  navigator.geolocation.watchPosition(position => {

    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    if (!myMarker) {
      myMarker = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#ffffff",
        fillColor: "#4285F4",
        fillOpacity: 1
      }).addTo(map).bindPopup("You");
    } else {
      myMarker.setLatLng([lat, lng]);
    }

    map.setView([lat, lng], 16);

    // ðŸ”¥ Save with timestamp
    myRef.set({
      lat,
      lng,
      lastActive: Date.now()
    });

    statusDiv.innerText = "Location active";

  }, error => {
    statusDiv.innerText = error.message;
  }, { enableHighAccuracy: true });

});

// ===== REALTIME LISTENER =====
db.ref("users").on("value", snapshot => {

  const users = snapshot.val() || {};
  const now = Date.now();
  const TIMEOUT = 30000; // 30 seconds

  for (const id in users) {

    const user = users[id];

    // ðŸ”¥ Remove inactive users automatically
    if (now - user.lastActive > TIMEOUT) {
      db.ref("users/" + id).remove();
      continue;
    }

    if (id === userId) continue;

    if (!friendsMarkers[id]) {
      friendsMarkers[id] = L.circleMarker([user.lat, user.lng], {
        radius: 8,
        color: "#ffffff",
        fillColor: "#000000",
        fillOpacity: 1
      }).addTo(map).bindPopup("Friend");
    } else {
      friendsMarkers[id].setLatLng([user.lat, user.lng]);
    }
  }

  // Remove missing users visually
  for (const id in friendsMarkers) {
    if (!users[id]) {
      map.removeLayer(friendsMarkers[id]);
      delete friendsMarkers[id];
    }
  }

});
</script>
